<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CNFT</title>
<link href="./bootstrap.min.css" rel="stylesheet">
<script src="./bootstrap.min.js"></script>
<script src="./jquery-3.6.0.min.js"></script>
<script type="text/javascript">
	var projectId = "rLi1KGBpzooHXTjCitUkbk7fd0I5osMI";
	function loadData() {
		var type = $("#type").val();
		if (type == "sold_by_date") {
			querySold();
		} else {
			queryListings(type == "listings_by_date");
		}
	}
	function querySold() {
		$("#table").empty();
		var key = $("#options").val();
		$.ajax({
			dataType: "json",
			url: "https://api.cnft.io/api/sold?search=" + key + "&sort=date&order=desc&count=100&page=1",
			success: function( json ) {
				var items = [];
				console.log("Assets: " + json.assets.length);
//				for (var i = 0; i < json.assets.length; i++) {
				for (var i = (json.assets.length - 1); i >= 0; i--) {
					var date = new Date(json.assets[i].date);
					var price = Math.round(json.assets[i].price/10000)/100;
					var unit = json.assets[i].unit;
					items.push( "<tr>" +
						"<td>" + json.assets[i].assetid + "</td>" +
						"<td>" + date.toLocaleString('lv-LV', { hour12: false }) + "</td>" +
						"<td>" + price + "</td>" +
						"<td><a href='https://cardanoscan.io/token/" + unit + "' target='_blank'>info</a></td>" +
						"<td><a href=\"javascript:loadAsset('" + unit + "')\">pool.pm</a></td>" +
						"<td><a href=\"javascript:loadOwner('" + unit + "')\">owner</a></td>" +
						"</tr>" );
				}
				
				$("#table").empty().append(items.join(""));
			},
			error: function( jqXHR, textStatus, errorThrown ) {
				$("#table").empty().append("<tr><td colspan='6'>" + textStatus + " : " + jqXHR.responseText + "</td></tr>");
			}
		});
	}
	function queryListings(byDate) {
		$("#table").empty();
		var key = $("#options").val();
		$.ajax({
			type: 'POST',
			dataType: "json",
			url: "https://api.cnft.io/market/listings",
			headers: {'Content-Type': 'application/x-www-form-urlencoded'},
			data: { search: key, sort: (byDate ? "date" : "price"), order: (byDate ? "desc" : "asc"), page: "1", count: "100", verified: "true" },
			success: function( json ) {
				var items = [];
				for (var i = 0; i < json.assets.length; i++) {
					var date = new Date(json.assets[i].listingDate);
					var price = Math.round(json.assets[i].price/10000)/100;
					var unit = json.assets[i].unit;
					items.push( "<tr>" +
						"<td>" + json.assets[i].assetid + "</td>" +
						"<td>" + date.toLocaleString('lv-LV', { hour12: false }) + "</td>" +
						"<td>" + price + "</td>" +
						"<td><a href='https://cardanoscan.io/token/" + unit + "' target='_blank'>info</a></td>" +
						"<td><a href=\"javascript:loadAsset('" + unit + "')\">pool.pm</a></td>" +
						"<td><a href=\"javascript:loadOwner('" + unit + "')\">owner</a></td>" +
						"</tr>" );
				}
				
				$("#table").empty().append(items.join(""));
			},
			error: function( jqXHR, textStatus, errorThrown ) {
				$("#table").empty().append("<tr><td colspan='6'>" + textStatus + " : " + jqXHR.responseText + "</td></tr>");
			}
		});
	}
	function hexToStr(hex) {
		var str = '';
		for (var n = 0; n < hex.length; n += 2) str += String.fromCharCode(parseInt(hex.substr(n, 2), 16));
		return str;
	}
	function loadAsset(id) {
		console.log("Asset: " + id);
		$.ajax({
			dataType: "json",
			url: "https://cardano-mainnet.blockfrost.io/api/v0/assets/" + id,
			headers: {'project_id': projectId},
			success: function( json ) {
				var policyId = json.policy_id;
				var assetName = hexToStr(json.asset_name);
				console.log("Asset: " + assetName);
				window.open('https://pool.pm/' + policyId + '.' + assetName, '_blank');
			}
		});
	}
	function loadOwner(id) {
		console.log("Asset: " + id);
		$.ajax({
			dataType: "json",
			url: "https://cardano-mainnet.blockfrost.io/api/v0/assets/" + id + "/addresses",
			headers: {'project_id': projectId},
			success: function( json ) {
				var address = json[0].address;
				console.log("Address: " + address);
				window.open('https://pool.pm/' + address, '_blank');
			}
		});
	}
</script>
</head>
<body>
<div class="col-lg-8 mx-auto p-3 py-md-5">
	<header class="d-flex align-items-center pb-3 mb-5 border-bottom">
		<a href="/" class="d-flex align-items-center text-dark text-decoration-none">
		<span class="fs-4">CNFT</span>
		</a>
	</header>
	<main>

	<div class="container">
		<div class="row">
			<div class="col">
				<select class="form-select" id="options">
					<option value="3383a7ea34c92eac945847641d4e8fd036fe213abf1f686710f30f56">Attack on Vitalik</option>
					<option value="1131301ad4b3cb7deaddbc8f03f77189082a5738c0167e1772233097">CardanoBits</option>
					<option value="b48990272ecef6e618a3cd3f83511ce58606117daa0921191eac5903">Cardano Caricatures</option>
					<option value="kidz">Cardano Kidz (all)</option>
					<option value="9bee44c5c494dee38622e6da0b3b312820f9f75dd6cc256c769db788">Cryptoknitties</option>
					<option value="788888fd99cb7ef837570ce5bf8808d959697a025adeca03d46349f1" selected="selected">KaizenNFT</option>
					<option value="1ec85dcee27f2d90ec1f9a1e4ce74a667dc9be8b184463223f9c9601">PXL</option>
					<option value="d5e6bf0500378d4f0da4e8dde6becec7621cd8cbf5cbb9b87013d4cc">SpaceBudz</option>
					<option value="b4c830cb0b1342f7b6c14b2ece2205a3a95ea19f78a3b6e5a9e1a321">The Galgos</option>
					<option value="e986d38f4ead45a4f909cb51d61d8d95efc72b12d9302cdd040974d1">The Hoskinsons</option>
					<option value="0e14267a8020229adc0184dd25fa3174c3f7d6caadcb4425c70e7c04">unsigned_algorithms</option>
				</select>
			</div>
			<div class="col">
				<select class="form-select" id="type">
					<option value="sold_by_date" selected="selected">Sold by date DESC</option>
					<option value="listings_by_price">Listings by price ASC</option>
					<option value="listings_by_date">Listings by date DESC</option>
				</select>
			</div>
			<div class="col">
				<button type="button" class="btn btn-primary" onclick="loadData()">Query...</button>
			</div>
		</div>
	</div>
	
	<br/>

	<div class="table-responsive">
	<table class="table table-sm table-striped">
		<thead>
			<tr>
				<th scope="col">ID</th>
				<th scope="col">Date</th>
				<th scope="col">Price</th>
				<th scope="col">#1</th>
				<th scope="col">#2</th>
				<th scope="col">#3</th>
			</tr>
		</thead>
		<tbody id="table">
		</tbody>
	</table>
	</div>

	</main>
	<footer class="pt-5 my-5 text-muted border-top">@avenepool &copy; 2021</footer>
</div>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-Q6G166EKF0"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-Q6G166EKF0');
</script>

</body>
</html>
